FROM image:version

ARG APT_PROXY
ARG APT_PROXY_SSL
ARG APP_UID=10001
ARG APP_GID=10001
ENV TOOL_VERSION="1.0.0" \
    TOOL_DOWNLOAD_URL="https://example.com/download" \
    TOOL_SHA256="replace-with-sha256"

RUN set -ex; \
    \
    buildDependencies=" \
        build-essential \
        curl \
    "; \
    if [ -n "$APT_PROXY" ]; then \
        echo "Acquire::http { Proxy \"http://${APT_PROXY}\"; };" > /etc/apt/apt.conf.d/00proxy; \
    fi; \
    if [ -n "$APT_PROXY_SSL" ]; then \
        echo "Acquire::https { Proxy \"https://${APT_PROXY_SSL}\"; };" >> /etc/apt/apt.conf.d/00proxy; \
    fi; \
    apt-get --yes update; \
    apt-get --yes install --no-install-recommends \
        $buildDependencies \
        runtime-package \
    ; \
    \
    # Build steps here...
    curl -L "$TOOL_DOWNLOAD_URL" -o /tmp/tool.tar.gz; \
    echo "$TOOL_SHA256  /tmp/tool.tar.gz" | sha256sum -c -; \
    tar -xf /tmp/tool.tar.gz -C /usr/local; \
    \
    # Cleanup
    apt-get purge --yes --auto-remove $buildDependencies; \
    rm -rf /tmp/* /var/tmp/* /var/lib/apt/lists/* /var/cache/apt/*; \
    rm -f /etc/apt/apt.conf.d/00proxy

RUN set -ex; \
    addgroup --system --gid "$APP_GID" appgroup; \
    adduser --system --uid "$APP_UID" --ingroup appgroup appuser; \
    mkdir -p /app /app/data; \
    chown -R appuser:appgroup /app

WORKDIR /app
COPY --chown=appuser:appgroup assets/ /app/

VOLUME [ "/app/data" ]
EXPOSE 8080
USER appuser
CMD [ "/app/entrypoint.sh" ]
